<html>
	<head>
		<meta charset="utf-8">
	</head>
	<body>
		<script type="module">
			import init, {compile} from './pkg/edit_fractal.js';

			let center_x = 0;
			let center_y = 0;
			let zoom = 4;
			const size = 400;

			let func_text = undefined;
			let func = undefined;

			async function reset_zoom() {
				center_x = 0;
				center_y = 0;
				zoom = 4;
				await run();
			}

			async function run() {
				const text = [
					document.getElementById('initial_z').value,
					document.getElementById('iteration').value
				];
				if (text !== func_text) {
					func_text = text;
					const program = compile(text);
					console.log(program);
					const mod = await WebAssembly.instantiate(program, {});
					console.log(mod);
					func = mod.instance.exports.return_thing;
				}
				const ctx = document.getElementById('canvas').getContext('2d');
				const image_data = ctx.createImageData(size, 1);
				const data = image_data.data;
				ctx.fillStyle = '#888';
				ctx.fillRect(0, 0, size, size);
				for (let y = 0; y < size; y++) {
					for (let x = 0; x < size; x++) {
						const cx = (x / size - 0.5) * zoom + center_x;
						const cy = (y / size - 0.5) * zoom + center_y;
						const value = func(cx, cy);
						if (value > 100) {
							data[4*x] = 255;
							data[4*x+1] = 255;
							data[4*x+2] = 255;
							data[4*x+3] = 255;
						} else {
							data[4*x] = value;
							data[4*x+1] = value;
							data[4*x+2] = value;
							data[4*x+3] = 255;
						}
					}
					ctx.putImageData(image_data, 0, y);
					if (y % 16 === 0) {
						await new Promise((resolve,reject) => setTimeout(resolve, 0));
					}
				}
			}

			async function canvas_click(e) {
				const x = e.offsetX;
				const y = e.offsetY;
				const cx = (x / size - 0.5) * zoom + center_x;
				const cy = (y / size - 0.5) * zoom + center_y;
				center_x = cx;
				center_y = cy;
				zoom /= 10;
				await run();
			}

			async function setup() {
				await init();
				document.getElementById('reset_zoom_button').onclick = reset_zoom;
				document.getElementById('run_button').onclick = run;
				document.getElementById('canvas').onclick = canvas_click;
			}
			setup();
		</script>
		<div>
		<input type="text" id="initial_z" autocomplete="off" value="0"> initial z
		</div>
		<div>
		<input type="text" id="iteration" autocomplete="off" value="z * z + c"> iteration
		</div>
		<div>
			<input type="button" id="run_button" value="Run">
			<input type="button" id="reset_zoom_button" value="Reset zoom">
		</div>
		<div>
			<canvas id="canvas" width="400" height="400"></canvas>
		</div>
	</body>
</html>
